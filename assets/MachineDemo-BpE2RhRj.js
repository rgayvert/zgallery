var k=Object.defineProperty;var A=(s,t,e)=>t in s?k(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var r=(s,t,e)=>(A(s,typeof t!="symbol"?t+"":t,e),e);import{bj as M,a as o,z as x,aM as v,q as y,b as i,B as T,ad as N,ab as E,p as f,aH as L,j as D,m as b,g as W,bk as $,f as B,e as O,c as u,H as g,I as F,G as X}from"./index-Bw2fO3vz.js";import{c as G}from"./TimerAtom-DgMrnHal.js";function I(s,t,e={}){const n=new V(s,e);return n.addAction(t),n}class V extends M{addAction(t){return super.addAction(t),this}performActionsAndDerivations(){this.val&&super.performActionsAndDerivations()}}class j{constructor(t){r(this,"logEntry",o(""));r(this,"currentState",o(void 0));r(this,"states",[]);r(this,"transitions",[]);r(this,"parentMachine");r(this,"submachines",[]);r(this,"debugText",o(""));r(this,"name");r(this,"stateList");r(this,"initialStateName");r(this,"active");this.options=t,this.name=this.options.name,this.stateList=this.options.states,this.initialStateName=this.options.initialStateName,this.active=this.options.active||o(!0),this.active.addAction(e=>e&&this.start()),this.active.addAction(e=>!e&&this.stop())}addSubmachine(t,e){this.submachines.push(e),this.stateNamed(t).machine=e,e.name=t,e.parentMachine=this,e.active=o(()=>e.name===this.currentStateName()),e.logEntry=this.logEntry}submachineNamed(t){return this.submachines.find(e=>e.name===t)}activePath(){if(this.isActive()){const t=this.submachines.find(e=>e.isActive());return t?[this,...t.activePath()]:[this]}else return[]}rootMachine(){return this.parentMachine?this.parentMachine.rootMachine():this}isActive(){return this.active.get()}currentStateName(){var t;return((t=this.currentState.get())==null?void 0:t.name)||""}log(t){console.log(`${this.name}:${t}`),this.logEntry.set(`${this.name}:${t}`)}start(){this.active.set(!0),this.log("start"),this.setCurrentState(this.stateNamed(this.initialStateName))}stop(){var t,e;this.active.set(!1),(e=(t=this.currentState.get())==null?void 0:t.machine)==null||e.stop(),this.log(`stop: state = ${this.currentState.get().name}`)}stateNamed(t){return this.states.find(e=>e.name===t)}setCurrentState(t){var c,a,h,l;const e=this.currentState.get(),n=typeof t=="string"?this.stateNamed(t):t;x.info(""+this.name+", oldState="+(e==null?void 0:e.name)+", newState="+(n==null?void 0:n.name)),this.currentState.set(n),(c=e==null?void 0:e.onExit)==null||c.call(e),(a=e==null?void 0:e.machine)==null||a.stop(),(h=n.onEnter)==null||h.call(n),this.isActive()&&((l=n.machine)==null||l.start())}parentStateName(){var t,e;return(e=(t=this.parentMachine)==null?void 0:t.currentState.get())==null?void 0:e.name}createXState(t,e){return{name:t,...e}}createXTransition(t){const e=this.stateNamed(t.from),n=this.stateNamed(t.to),c=o(()=>t.when());return{name:t.name,from:e,to:n,condition:I(()=>[this.currentState.get()===e,c.get()].every(Boolean),()=>this.transitionFired(e,n))}}configure(){this.states=Object.entries(this.getStates()).map(([t,e])=>this.createXState(t,e)),this.transitions=this.getTransitions().map(t=>this.createXTransition(t)),this.debugText=o(()=>this.debugDescription()),this.isActive()}currentStateDescription(){var t;return`${v((t=this.currentState.get())==null?void 0:t.description)}`}debugDescription(){return`state: ${this.currentStateName()} / ${this.currentStateDescription()}`}beforeTransition(){}afterTransition(){}transitionFired(t,e){this.isActive()&&(this.log(`${t.name} -> ${e.name}`),this.beforeTransition(),this.setCurrentState(e),this.afterTransition())}}class w extends j{constructor(e){super({intervalMillis:1e3,resetCounterAfterTransition:!0,...e});r(this,"counter",y(0,{action:e=>console.log("counter="+e)}));r(this,"timer");this.options=e,this.timer=G(()=>this.counter.increment(),this.options.intervalMillis,{action:n=>this.log(n)})}start(){this.counter.set(0),this.timer.start(),super.start()}stop(){this.timer.stop(),super.stop()}afterTransition(){v(this.options.resetCounterAfterTransition)&&this.counter.set(0)}}const z=["on","off"];class S extends w{constructor(e){const n={name:e.name||"toggle",states:z,initialStateName:"on"};super({...n,...e});r(this,"on",o(void 0));this.configure()}isIdle(){return this.on.get()===void 0}isOn(){return this.on.get()===!0}isOff(){return this.on.get()===!1}start(){console.log("START"),super.start(),this.active.set(!0)}stop(){console.log("STOP"),super.stop(),this.active.set(!1)}getStates(){return{on:{onEnter:()=>this.on.set(!0)},off:{onEnter:()=>this.on.set(!1)}}}afterTransition(){console.log("counter="+this.counter.get()),super.afterTransition()}getTransitions(){return[{from:"on",to:"off",when:()=>this.counter.get()%2===0},{from:"off",to:"on",when:()=>this.counter.get()%2===1}]}}function d(s){const t=["red","yellow","green"],e={red:o(()=>s.light.get()==="red"?i.color.red:i.color.gray),yellow:o(()=>s.light.get()==="yellow"?i.color.yellow:i.color.gray),green:o(()=>s.light.get()==="green"?i.color.green:i.color.gray)};function n(a,h,l){return L({cx:30,cy:l,stroke:i.color.black,r:25,strokeWidth:2,fill:a,transition:"fill 0.3s"})}const c={border:i.border.thin,rounding:i.rounding.r3,background:i.color.gray,model:s};return T(c).append(N({bounds:E(0,0,60,170),width:f(60),height:f(160)}).append(...t.map((a,h)=>n(e[a],i.color[a],h*55+30))))}const H=["red","yellow","green"];class p extends w{constructor(e,n,c){super({name:e,states:H,initialStateName:"red",intervalMillis:n,active:c,resetCounterAfterTransition:!0});r(this,"light",o("red"));this.configure()}getStates(){return{red:{onEnter:()=>this.light.set("red")},green:{onEnter:()=>this.light.set("green")},yellow:{onEnter:()=>this.light.set("yellow")}}}getTransitions(){return[{from:"red",to:"green",when:()=>this.counter.get()===5},{from:"green",to:"yellow",when:()=>this.counter.get()===4},{from:"yellow",to:"red",when:()=>this.counter.get()===2}]}}function m(s,t){function e(){return W({label:o(()=>t.get()?"Stop":"Start"),action:()=>t.toggle(),width:b(10),rounding:i.rounding.pill,ripple:!1})}function n(){return $(s.logEntry,{width:B(100),height:O(8),border:i.border.thin,padding:i.space.s2})}return D({width:b(30),gap:i.space.s5}).append(e(),n())}function P(){const s=u(!1),t=new p("TL",1e3,s);return g({gap:i.space.s8}).append(d(t),m(t,s))}class R extends p{constructor(e,n,c,a){super(e,n,a);r(this,"blinkMachine");this.configure();const h=o(()=>a.get()&&this.currentStateName()==="green");this.blinkMachine=new S({name:"blink",intervalMillis:c,active:h})}}function C(s){const t=o(()=>s.isActive()?"icon.walk":"icon.stop"),e=o(()=>s.isActive()&&s.isOff()?.2:1),n=o(()=>s.isActive()?i.color.green:i.color.red);return T({border:i.border.medium,background:i.color.background,padding:i.space.s4,model:s}).append(F(t,{font:i.font.display_medium,opacity:e,color:n}))}function q(){const s=u(!1),t=new R("cw",1e3,500,s);return g({gap:i.space.s8}).append(d(t),C(t.blinkMachine),m(t,s))}class U extends p{constructor(e,n,c,a){super(e,n,a);r(this,"blink");this.configure(),this.blink=new S({name:"blink",intervalMillis:c}),this.addSubmachine("green",this.blink)}}function _(){const s=u(!1),t=new U("cw",1e3,500,s);return g({gap:i.space.s8}).append(d(t),C(t.blink),m(t,s))}function Z(){return X(J)}const J={sourceDir:"/source/Demos/Machines",sections:[{title:"Traffic Light",componentFn:P,sources:["TLExample.ts","TLMachine.ts","TL.ts","TLControls.ts"],markdown:"TLExample.md"},{title:"Crosswalk (Concurrent)",componentFn:q,sources:["CWExample.ts","CWMachine.ts","CWLight.ts","TLControls.ts"],markdown:"CrosswalkExample.md"},{title:"Crosswalk (Nested)",componentFn:_,sources:["CWNestedExample.ts","CWNestedMachine.ts","CWLight.ts","TLControls.ts"],markdown:"CrosswalkNestedExample.md"}]};export{Z as MachineDemo,Z as default};
